name: Sync to Dedicated Repos

on:
  push:
    branches: [main, master]
    paths:
      - 'parachord-extension/**'
  workflow_dispatch:
    inputs:
      sync_extension:
        description: 'Sync browser extension'
        required: false
        type: boolean
        default: true

jobs:
  sync-browser-extension:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.sync_extension == 'true' ||
      github.event_name == 'push'

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for extension changes
        id: check_changes
        if: github.event_name == 'push'
        run: |
          # Get the list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

          # Check if any extension files changed
          if echo "$CHANGED_FILES" | grep -q "^parachord-extension/"; then
            echo "extension_changed=true" >> $GITHUB_OUTPUT
            echo "Extension files changed:"
            echo "$CHANGED_FILES" | grep "^parachord-extension/"
          else
            echo "extension_changed=false" >> $GITHUB_OUTPUT
            echo "No extension files changed"
          fi

      - name: Sync to parachord-browser-extension repo
        if: |
          github.event_name == 'workflow_dispatch' ||
          steps.check_changes.outputs.extension_changed == 'true'
        env:
          SYNC_TOKEN: ${{ secrets.REPO_SYNC_TOKEN }}
        run: |
          if [ -z "$SYNC_TOKEN" ]; then
            echo "::error::REPO_SYNC_TOKEN secret is not set. Please add a personal access token with repo scope."
            exit 1
          fi

          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone the target repo
          TARGET_REPO="https://x-access-token:${SYNC_TOKEN}@github.com/Parachord/parachord-browser-extension.git"
          git clone "$TARGET_REPO" target-repo

          # Get the source commit info for the sync commit message
          SOURCE_COMMIT=$(git rev-parse --short HEAD)
          SOURCE_MSG=$(git log -1 --pretty=format:"%s")

          # Remove old files from target (except .git)
          cd target-repo
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +

          # Copy extension files to target
          cp -r ../parachord-extension/* .

          # Check if there are changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to sync"
            exit 0
          fi

          # Stage and commit
          git add -A
          git commit -m "Sync from parachord monorepo (${SOURCE_COMMIT}): ${SOURCE_MSG}"

          # Push changes
          git push origin main || git push origin master

          echo "Successfully synced browser extension to dedicated repo"
